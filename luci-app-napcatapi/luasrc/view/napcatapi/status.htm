<script type="text/javascript">
// è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
function openCustomWindow(url, windowName, width = 800, height = 600) {
    // å…¥å‚æ ¡éªŒ
    if (!url || !windowName) {
        console.error('âŒ URLå’Œçª—å£åç§°ä¸ºå¿…å¡«å‚æ•°');
        return null;
    }
    const validWidth = Math.max(300, typeof width === 'number' ? width : 800);
    const validHeight = Math.max(200, typeof height === 'number' ? height : 600);

    // è®¡ç®—å±…ä¸­ä½ç½®
    const screenWidth = window.screen.availWidth;
    const screenHeight = window.screen.availHeight;
    const left = Math.max(0, (screenWidth - validWidth) / 2);
    const top = Math.max(0, (screenHeight - validHeight) / 2);

    // çª—å£ç‰¹æ€§é…ç½®
    const features = [
        `width=${validWidth}`,
        `height=${validHeight}`,
        `left=${left}`,
        `top=${top}`,
        'resizable=no',       // ç¦æ­¢è°ƒæ•´å¤§å°
        'scrollbars=yes',     // æ˜¾ç¤ºæ»šåŠ¨æ¡
        'toolbar=no',         // éšè—å·¥å…·æ 
        'menubar=no',         // éšè—èœå•æ 
        'location=no',        // éšè—åœ°å€æ ï¼ˆéƒ¨åˆ†æµè§ˆå™¨å¼ºåˆ¶æ˜¾ç¤ºï¼‰
        'status=no',          // éšè—çŠ¶æ€æ 
        'movable=no',         // ç¦æ­¢æ‹–åŠ¨ï¼ˆä»…Safariæ”¯æŒï¼‰
        'directories=no'      // å…¼å®¹æ—§æµè§ˆå™¨
    ].join(',');

    // æ‰“å¼€çª—å£å¹¶å¤„ç†æ‹¦æˆª
    try {
        const newWindow = window.open(url, windowName, features);
        if (!newWindow) {
            alert('âš ï¸ çª—å£æ‰“å¼€å¤±è´¥ï¼Œè¯·å…è®¸æµè§ˆå™¨å¼¹çª—æƒé™åé‡è¯•');
            console.warn('ğŸš« å¼¹çª—è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œéœ€å¼€å¯å¼¹çª—æƒé™');
        }
        return newWindow;
    } catch (err) {
        console.error('âŒ æ‰“å¼€çª—å£å‡ºé”™ï¼š', err);
        alert('âš ï¸ æ‰“å¼€çª—å£æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        return null;
    }
}

// è¡¥å…¨String.formatå‡½æ•°
if (!String.format) {
    String.format = function(fmt) {
        var args = Array.prototype.slice.call(arguments, 1);
        return fmt.replace(/%s/g, function() {
            return args.shift() || '';
        });
    };
}

// 5ç§’è½®è¯¢çŠ¶æ€
window.onload = function() {
    // ä¿®å¤æ¥å£è·¯å¾„ï¼šå¯¹åº”æ§åˆ¶å™¨çš„æ­£ç¡®è·¯å¾„
    XHR.poll(5, '<%=url("admin/services/napcatapi_status")%>', null, function(x, st) {
        var tb = document.getElementById('status_id');
        if (!tb) return;
        st = st || { running: false, port: 80, token: '' };
        if (st.running) {
            // æ‹¼æ¥URL
            const hostname = window.location.hostname;
            const baseUrl = 'http://' + hostname + ':' + st.port;
            const interfaceUrl = baseUrl + '?token=' + st.token;
            const logUrl = baseUrl + '/log?token=' + st.token;
            const napcatUrl = baseUrl + '/napcat?token=' + st.token;

            // è¿è¡ŒçŠ¶æ€æ–‡æœ¬ï¼ˆè¿è¡Œä¸­-ç»¿è‰²ï¼‰
            const status = '<span style="color:green"><strong>' + _('NapCat API: RUNNING') + '</strong></span>';
            
            // æ¢å¤æŒ‰é’®æ‹¼æ¥
            const buttonEdit = String.format(
                '&#160;<a class="btn cbi-button" href="javascript:void(0);" onclick="openCustomWindow(\'%s\', \'Edit\', 1200, 1100)">%s</a>',
                interfaceUrl, _('Open Web edit')
            );
            const buttonLogs = String.format(
                '&#160;<a class="btn cbi-button" href="javascript:void(0);" onclick="openCustomWindow(\'%s\', \'Logs\', 1200, 1050)">%s</a>',
                logUrl, _('Open Web logs')
            );
            const buttonNapcat = String.format(
                '&#160;<a class="btn cbi-button" href="javascript:void(0);" onclick="openCustomWindow(\'%s\', \'Napcat\', 880, 980)">%s</a>',
                napcatUrl, _('Open Web napcat')
            );
            tb.innerHTML = status// + buttonEdit + buttonLogs + buttonNapcat;
        } else {
            // æœåŠ¡æœªè¿è¡Œï¼ˆçº¢è‰²æç¤ºï¼‰
            tb.innerHTML = '<span style="color:red"><strong>' + _('NapCat API: NOT RUNNING') + '</strong></span>';
        }
    });
};
</script>

<!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
<fieldset class="cbi-section">
    <legend><%:NapCat API Status%></legend>
    <p id="status_id">
        <em><%:Collecting data...%></em>
    </p>
</fieldset>