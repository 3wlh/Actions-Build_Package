<%+header%>
<% local interface = "edit" %>
<style>
  .cbi-map {
    height: 100% !important;
    margin: 0 !important;
    padding: 2px !important;
    box-sizing: border-box;
  }

  .button {
    background-color: #4caf50;
    border: none;
    color: white;
    padding: 12px 45px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin: 10px 5px;
    letter-spacing: 0.5px;
  }

  .button:hover {
    background-color: #45a049;
  }

  .button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  /* 编辑器容器元素 */
  .editor-container {
    width: 100% !important;
    flex: 1 1 auto !important;
    border: 1px solid #59acff;
    border-radius: 8px;
    box-shadow: 0 0 12px #719ece;
    overflow: hidden;
    position: relative;
    min-height: 0;
  }

  .CodeMirror-linenumbers {
    font-size: 18px !important;
    padding: 0 5px !important;
  }

  /* CodeMirror容器 */
  .CodeMirror {
    font-family:
    "Source Han Mono", Consolas, "Courier New", monospace !important;
    padding: 2px;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    line-height: 1.4 !important;
    font-size: 20px !important;
  }

  .legend {
    color: #333;
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    letter-spacing: 1px;
  }

  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    max-width: 350px;
    text-align: left;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    z-index: 99999;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    transform: translateX(120%);
  }

  .toast.success {
    background-color: rgba(27, 165, 59, 0.7);
  }

  .toast.error {
    background-color: rgba(189, 44, 58, 0.9);
  }

  .toast.warning {
    background-color: rgba(255, 193, 7, 0.7);
  }

  .toast.show {
    opacity: 1;
    transform: translateX(0);
  }

  fieldset {
    border: 1px solid #ddd;
    padding: 2px;
    border-radius: 8px;
    background-color: white;
    flex: 1 1 auto !important;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100% !important;
  }
</style>

<div class="cbi-map">
  <fieldset>
    <legend class="legend"><%:配置编辑%></legend>
    <div class="editor-container" id="editor-container"></div>
    <div style="text-align: center; margin-top: 20px; flex-shrink: 0">
      <input
        class="button"
        type="button"
        value="<%:保存修改%>"
        onclick="SaveFile()"
      />
    </div>
  </fieldset>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/codemirror@6.65.7/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@6.65.7/mode/yaml/yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@6.65.7/mode/javascript/javascript.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/codemirror@6.65.7/lib/codemirror.min.css"
/>

<script>
  // 初始化编辑器函数
  function initEditor() {
      editor = CodeMirror(document.getElementById("editor-container"), {
      mode: { name: "yaml", json: true },
      lineNumbers: true,
      indentUnit: 2,
      tabSize: 2,
      lineWrapping: true,
      spellcheck: false,
      cursorHeight: 1,

    });
    setTimeout(function() {
      editor.refresh();
    }, 100);
  }

  // 弹出框
  function showToast(message, type, duration) {
    type = type || "warning";
    duration = duration || 3000;
    toast.textContent = message;
    toast.className = "toast " + type;
    toast.classList.add("show");
    setTimeout(function () {
      toast.classList.remove("show");
    }, duration);
  }

  // 保留编辑器位置
  function saveEditorPosition() {
    return {
      cursor: editor.getCursor(),
      scroll: editor.getScrollInfo()
    };
  }

  function restoreEditorPosition(pos) {
    if (!pos) return;
    editor.scrollTo(pos.scroll.left, pos.scroll.top);
    editor.setCursor(pos.cursor);
    editor.focus();
  }

  // 获取数据
  async function QueryFile(isFromSave = true) {
    var editorPos = saveEditorPosition();
    fetch("<%=luci.dispatcher.build_url("admin", "services", "edit", interface.."_read")%>")
    .then(res => {
        if (!res.ok) throw new Error('<%:Network response was not ok%>');
        return res.json();
     })
     .then(data => {
      if (data.code === 0) {
        editor.setValue(data.data || "");
        if (isFromSave) {
            showToast('<%:File loaded successfully%>', 'success', 3000);
         }
       } else {
        editor.setValue("");
         showToast(`<%:Error%>: ${data.msg || '<%:Unknown error%>'}`, 'error', 4000);
       }
     // 恢复编辑器位置
      restoreEditorPosition(editorPos);
    })
    .catch(err => {
       showToast(`<%:Network error%>: ${err.message}`, 'error', 4000);
    });
    }

  window.onload = function () {
    toast = document.getElementById("toast");
    initEditor();
    window.addEventListener("resize", function () {
      editor.refresh();
    });
    editor.refresh();
    setTimeout(function() {
      editor.refresh();
    }, 100);
    QueryFile();
  }
    // 保存按钮点击事
    async function SaveFile() {
      //showToast('<%:Saving file...%>', 'warning');
      // 获取编辑器内容
      const configContent = editor.getValue() || "";
      if (!configContent) {
        showToast("<%:The content cannot be empty！%>", "error");
        return;
      }
      const formData = new FormData();
      formData.append('content', configContent);
      fetch("<%=luci.dispatcher.build_url("admin", "services", "edit", interface.."_save")%>", {
          method: 'POST',
          body: formData
      })
      .then(res => {
          if (!res.ok) throw new Error('<%:Save request failed%>');
          return res.json();
      })
      .then(data => {
          if (data.code === 0) {
              QueryFile(false);
              showToast(data.msg || '<%:File saved successfully%>', 'success', 4000);
          } else {
              showToast(`<%:Save failed%>: ${data.msg || '<%:Unknown error%>'}`, 'error', 4000);
          }
      })
      .catch(err => {
          showToast(`<%:Save error%>: ${err.message}`, 'error', 4000);
      });
    }
</script>
<%+footer%>