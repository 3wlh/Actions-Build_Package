name: Actions_ipkg-Feed

on:
  workflow_call:
  schedule:
    #- cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿä¸€æ¬¡
    - cron: '0 16 */2 * *'  # æ¯2å¤©è¿è¡Œä¸€æ¬¡
  repository_dispatch:
  workflow_dispatch:

env:
  Arch: "aarch64_generic x86_64"
  Path: "${{ github.workspace }}/GitHub/OpenWrt_Packages"
  IPKG: "https://raw.githubusercontent.com/openwrt/openwrt/refs/heads/main/scripts/ipkg-make-index.sh"
  Packages: "https://3wlh:${{ secrets.TOKEN_3WLH }}@github.com/3wlh/OpenWrt_Packages"
  USIGN: "https://github.com/openwrt/usign.git"

jobs:
  jod_feed:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0
    
    - name: Initialization environment
      run: |
        # sudo -E apt-get -qq -y update
        # sudo -E apt-get -qq -y install python3 gzip
        sudo timedatectl set-timezone "Asia/Shanghai"
         
    - name: Git Clone Repositories
      id: git_clone
      run : |
        test -d "GitHub" || mkdir -p "GitHub"
        cd GitHub && git clone "${{ env.Packages }}"
        test -d "OpenWrt_Packages" && cd "OpenWrt_Packages"
        test -f "mime.pub" || echo -e "${{ secrets.PUD }}" > mime.pub
        if [[ -f bin/usign ]]; then
          cp -f bin/usign /usr/local/bin/usign
        else
          git clone "${{ env.USIGN }}"
          sudo -E apt-get -qq -y install cmake
          echo "usign=fail" >> $GITHUB_OUTPUT
        fi
    
    - name: Install usign
      if: steps.git_clone.outputs.usign == 'fail'
      run : |
        chmod -R 755 "${{ github.workspace }}/GitHub/OpenWrt_Packages/usign" && \
        cd ${{ github.workspace }}/GitHub/OpenWrt_Packages/usign && \
        cmake . && make && sudo make install
        test -d "${{ github.workspace }}/GitHub/OpenWrt_Packages/bin" || mkdir -p "${{ github.workspace }}/GitHub/OpenWrt_Packages/bin"
        cp -f /usr/local/bin/usign ${{ github.workspace }}/GitHub/OpenWrt_Packages/bin
        rm -rf ${{ github.workspace }}/GitHub/OpenWrt_Packages/usign
        
    - name: Install ipkg-make-index
      run : |
        test -f "$(pwd)/.github/.shell/ipkg-make-index.sh" || \
        curl -# -L --fail "${{ env.IPKG }}" > $(pwd)/.github/.shell/ipkg-make-index.sh
        sed -i -e 's/$MKHASH sha256 $pkg/sha256sum $pkg | awk '\''{print $1}'\''/' \
        -e 's/$sed_safe_pkg/$(basename ${sed_safe_pkg})/' $(pwd)/.github/.shell/ipkg-make-index.sh
        
    - name: Create Script
      run : |
        chmod -R 755 "$(pwd)/.github/.shell" "$(pwd)/.github/.packages"
        for file in $(pwd)/.github/.shell/*.sh $(pwd)/.github/.packages/*.sh ;do
          if [[ -f ${file} ]];then
            name=$(basename ${file} .sh)
            sudo ln -s ${file} /bin/${name}
            echo "$(date '+%Y-%m-%d %H:%M:%S') - ${name} åˆ›å»ºOK."
          fi
        done
        
    - name: Download aarch64_generic Packages
      run : |
        Packages_all "aarch64_generic" "${{ env.Path }}"
        test -d "${{ env.Path }}/packages/aarch64_generic" || \
        mkdir -p "${{ env.Path }}/packages/aarch64_generic"
        find "/tmp/packages/aarch64_generic" -type f -name "*.[ia]pk" -exec mv -f {} "${{ env.Path }}/packages/aarch64_generic" \;
    
    - name: Download x86_64 Packages
      run : |
        Packages_all "x86_64" "${{ env.Path }}"
        test -d "${{ env.Path }}/packages/x86_64" || \
        mkdir -p "${{ env.Path }}/packages/x86_64"
        find "/tmp/packages/x86_64" -type f -name "*.[ia]pk" -exec mv -f {} "${{ env.Path }}/packages/x86_64" \;      
            
    - name: Create Repositories index 
      run : |  
        # gzip -k9 Packages
        Arch=(${{ env.Arch }})
        echo -e "${{ secrets.KEY }}" > /tmp/mime.key
        cd ${{ github.workspace }}/GitHub/OpenWrt_Packages/packages
        for arch in "${Arch[@]}"; do
          [[ -d "${arch}" ]] && ipkg-make-index ${arch} > ${arch}/Packages
          [[ -f "${arch}/Packages" ]] && \
          gzip -fk9c ${arch}/Packages > ${arch}/Packages.gz && \
          usign -S -m ${arch}/Packages -s /tmp/mime.key -x ${arch}/Packages.sig
        done
        
    - name: Git Erase Commits
      run : |
        git config --global user.email "github-actions[bot]@github.com"
        git config --global user.name "GitHub_Actions[bot]"
        
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        cd ${{ github.workspace }}/GitHub/OpenWrt_Packages
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add -A
        # æäº¤æ›´æ”¹
        git commit -am "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} update $(date +%Y-%m-%d" "%H:%M:%S)"
        # æ¸…ç†ä¼˜åŒ–Gitä»“åº“
        # git gc --prune=now --aggressive >/dev/unll
        # å¼ºåˆ¶æäº¤åˆ°è¿œç¨‹ä»“åº“
        git push origin main
        
  jod_workflow: 
    needs: jod_feed
    uses: ./.github/workflows/Actions_GitHub_Workflow.yml
    secrets: inherit
    with:
      reuse: true